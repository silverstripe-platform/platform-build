# Core tools / PHP extensions
FROM composer:1@sha256:f18b06a0bc37800190e7e6d6fcec33dcc48679c1b6ad28993f81a5488abd7041 AS composer
FROM php:7.3-cli@sha256:898f13367b6e0471a003607a1c0bd3f942e61732eb6380d9b79b1f4ce4759128

# Install core dependencies
RUN apt-get update && apt-get install -y curl git jq zip libzip-dev gnupg
RUN mv "$PHP_INI_DIR/php.ini-production" "$PHP_INI_DIR/php.ini"
RUN pecl install zip && docker-php-ext-enable zip

# Pull Composer from base image
COPY --from=composer /usr/bin/composer /usr/local/bin/composer

# Adding a non-root user to execute scripts in the container
RUN useradd -d /home/build -s /usr/sbin/nologin -m -u 2000 -U build

# Install Yarn
RUN curl -sS https://dl.yarnpkg.com/debian/pubkey.gpg | apt-key add -
RUN echo "deb https://dl.yarnpkg.com/debian/ stable main" | tee /etc/apt/sources.list.d/yarn.list
RUN apt-get update && apt-get install -y --no-install-recommends yarn

USER build

# Allow uninhibited SSH connections to support fetching external resources
RUN mkdir -p ~/.ssh
RUN chmod 0700 ~/.ssh
RUN printf "Host *\nStrictHostKeyChecking no\nUserKnownHostsFile /dev/null\n" > ~/.ssh/config
RUN chmod 400 ~/.ssh/config

# Install legacy vendor-plugin-helper module as a fallback for exposing assets
RUN composer global require silverstripe/vendor-plugin-helper

WORKDIR /home/build

# Fetch NVM installer and prep destination
ENV NVM_DIR=/home/build/.nvm
RUN mkdir -p ~/.nvm
RUN curl https://raw.githubusercontent.com/creationix/nvm/v0.35.3/install.sh > install.sh

# Verify that the NVM installer remains uncompromised - bail on the build if not
ENV NVM_EXPECTED_HASH="fbd8e6289e6e83d0809ef96bf73cd699  install.sh"
RUN if [ "`md5sum install.sh`" != "$NVM_EXPECTED_HASH" ]; then exit 1; fi;

# Install NVM without a default Node binary, add 6 + 8 + 10 + 12
ENV NODE_VERSION=
RUN bash install.sh
RUN . $NVM_DIR/nvm.sh && nvm install v6 && nvm install v8 && nvm install v10 && nvm install v12

COPY --chown=build:build funcs.sh /home/build/funcs.sh
COPY --chown=build:build parse_composer.php /home/build/parse_composer.php
COPY --chown=build:build build-project.sh /home/build/build-project.sh

COPY --chmod=500 docker-entrypoint.sh /docker-entrypoint.sh

WORKDIR /app

USER root

ENTRYPOINT ["/docker-entrypoint.sh", "build"]